<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è² æ•¸åŠ æ¸›ï½œæ•¸ç·šç·´ç¿’èˆ‡æ¸¬é©—</title>
<style>
  :root{
    --bg:#fff8fb;
    --card:#ffffff;
    --primary:#7c5cff;
    --accent:#ff82b1;
    --ink:#2b2b2b;
    --muted:#7a7a7a;
    --good:#17b26a;
    --bad:#ef4444;
    --gold:#f5b301;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: linear-gradient(180deg,var(--bg),#f8fbff);
    color:var(--ink);
  }
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:16px 20px; position:sticky; top:0; backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.7); border-bottom:1px solid #eee;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .brand .logo{
    width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    background: radial-gradient(circle at 30% 30%, #ffd9e8, #d9e4ff);
    box-shadow: 0 6px 16px rgba(124,92,255,0.25) inset;
    font-size:22px;
  }
  .brand h1{font-size:18px; margin:0;}
  .toolbar{display:flex; gap:10px; align-items:center;}
  .pill{
    background:var(--card); border:1px solid #eee; padding:8px 12px; border-radius:999px;
    display:flex; align-items:center; gap:8px;
  }
  input[type="text"]{
    border:none; outline:none; background:transparent; min-width:120px; font-size:14px;
  }
  button, .btn{
    cursor:pointer; border:none; padding:10px 14px; border-radius:12px; font-weight:600;
    background:var(--primary); color:white; box-shadow:0 6px 16px rgba(124,92,255,0.25);
    transition: transform .06s ease;
  }
  button.ghost{background:#f2f2ff; color:#4b4bb5; box-shadow:none}
  button.flat{background:#efefef; color:#333; box-shadow:none}
  button:active{transform: translateY(1px)}
  .layout{
    display:grid; grid-template-columns: 1fr 380px; gap:18px; padding:18px; max-width:1200px; margin:0 auto;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns: 1fr}
  }
  .card{
    background:var(--card); border:1px solid #eee; border-radius:18px; padding:16px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.04);
  }
  .scorebar{
    display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-bottom:12px;
  }
  .chip{
    background:#f7f7ff; border:1px dashed #d7d7ff; border-radius:12px; padding:10px; text-align:center;
    font-weight:700; color:#4b4bb5;
  }
  .big-op{
    font-size: clamp(22px, 2.2vw, 26px);
    display:flex; align-items:center; justify-content:center; gap:8px; margin:6px 0 12px;
  }
  .big-op .bubble{
    background:#fff4f9; border:2px solid #ffd6ea; color:#c84580; font-weight:800;
    padding:8px 12px; border-radius:12px;
  }
  .numline-wrap{
    background: #fff9fb;
    border:1px dashed #ffd0e6; border-radius:16px; padding:10px; margin:10px 0 4px;
  }
  svg{width:100%; height:auto;}
  .answer-row{
    display:flex; gap:10px; align-items:center; margin-top:8px; flex-wrap:wrap;
  }
  .answer-row input[type="number"]{
    width:110px; padding:10px; border-radius:12px; border:1px solid #ddd; font-size:18px; font-weight:700;
  }
  .result-msg{min-height:24px; font-weight:800;}
  .ok{color:var(--good)} .ng{color:var(--bad)}
  .mode-tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
  .mode-tabs button{background:#ffeefe; color:#7b3a6a}
  .mode-tabs button.active{background:var(--accent); color:#fff}
  .right-col .section{margin-bottom:14px}
  .list{display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto}
  .list .row{
    display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:8px 12px; border:1px solid #eee; border-radius:10px;
  }
  .tiny{font-size:12px; color:var(--muted)}
  .meter{height:8px; background:#eee; border-radius:999px; overflow:hidden}
  .meter > div{height:100%; background: linear-gradient(90deg, #a4b5ff, #ff9bd3)}
  .label{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  .rank-medal{font-size:20px}
  .footer-note{font-size:12px; color:var(--muted); text-align:center; margin-top:8px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">â•</div>
    <h1>è² æ•¸åŠ æ¸›ï½œæ•¸ç·šç·´åŠŸæˆ¿</h1>
  </div>
  <div class="toolbar">
    <div class="pill">
      <span>ğŸ‘¤ åç¨±</span>
      <input id="nickname" type="text" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±â€¦" />
    </div>
    <button id="btnSettings" class="ghost">âš™ï¸ è¨­å®š</button>
  </div>
</header>

<div class="layout">
  <!-- ä¸»ç·´ç¿’å€ -->
  <main class="card">
    <div class="mode-tabs">
      <button data-mode="practice" class="active">ğŸŒ± ç·´ç¿’ï¼ˆæœ‰æ•¸ç·šï¼‰</button>
      <button data-mode="review">ğŸ§© éŒ¯é¡Œè¤‡ç¿’</button>
      <button data-mode="exam">ğŸ¯ æ¸¬é©—ï¼ˆç„¡æ•¸ç·šï¼‰</button>
    </div>

    <div class="scorebar">
      <div class="chip">â­ åˆ†æ•¸ <span id="score">0</span></div>
      <div class="chip">ğŸ”¥ é€£æ“Š <span id="streak">0</span></div>
      <div class="chip">ğŸ“ ç†Ÿç·´åº¦ <span id="mastery">0%</span></div>
      <div class="chip">ğŸ† æœ€é«˜åˆ† <span id="best">0</span></div>
    </div>

    <div class="big-op">
      <div class="bubble" id="opA">-3</div>
      <div class="bubble" id="opSign">-</div>
      <div class="bubble" id="opB">2</div>
      <div class="bubble">=</div>
      <div>
        <input id="answer" type="number" inputmode="numeric" />
      </div>
      <button id="btnSubmit">é€å‡º</button>
      <button id="btnSkip" class="flat">ç•¥é</button>
    </div>

    <div id="numlineWrap" class="numline-wrap">
      <div class="label">æ•¸ç·šæç¤º</div>
      <svg id="numline" viewBox="0 0 800 150" preserveAspectRatio="xMidYMid meet" role="img" aria-label="æ•¸ç·šé¡¯ç¤º"></svg>
    </div>

    <div class="answer-row">
      <div id="resultMsg" class="result-msg"></div>
      <button id="btnNext" class="hidden">ä¸‹ä¸€é¡Œ â–¶</button>
      <button id="btnShowSteps" class="ghost hidden">é¡¯ç¤ºæ­¥é©Ÿ</button>
    </div>

    <div class="footer-note">æç¤ºï¼šå¯åœ¨å³ä¸Š âš™ï¸ è¨­å®šèª¿æ•´ã€Œæ•¸å€¼ç¯„åœã€éŸ³æ•ˆã€æ˜¯å¦è‡ªå‹•é€²å…¥æ¸¬é©—ã€ç­‰ã€‚</div>
  </main>

  <!-- å³å´ï¼šæ’è¡Œæ¦œ / éŒ¯é¡Œå‹ / æ­·ç¨‹ -->
  <aside class="right-col">
    <div class="card section" id="panelLeaderboardLocal">
      <h3>ğŸ“Š æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</h3>
      <div class="list" id="localRanks"></div>
      <div class="tiny">åªè¨˜éŒ„æ­¤è£ç½®ä¸Šçš„æœ€ä½³æˆç¸¾ã€‚</div>
    </div>

    <div class="card section hidden" id="panelLeaderboardCloud">
      <h3>ğŸŒ æ’è¡Œæ¦œï¼ˆé›²ç«¯æˆ¿é–“ï¼‰</h3>
      <div class="list" id="cloudRanks"></div>
      <div class="tiny">ä½¿ç”¨ Firebaseï¼ˆé¸å¡«ï¼‰ã€‚è€å¸«å¯åœ¨ âš™ï¸ è¨­å®šè²¼ä¸Š Firebase è¨­å®šä¸¦è¼¸å…¥æˆ¿é–“ä»£ç¢¼ã€‚</div>
    </div>

    <div class="card section">
      <h3>ğŸ§  å¸¸éŒ¯é¡Œå‹é›·é”</h3>
      <div class="tiny">å››å¤§å‹æ…‹ï¼š(-a)+bã€a+(-b)ã€(-a)+(-b)ã€(-a)-b</div>
      <div class="list" id="errorTypes"></div>
    </div>

    <div class="card section">
      <h3>ğŸ“œ æœ€è¿‘ç­”é¡Œ</h3>
      <div class="list" id="recentLog"></div>
    </div>
  </aside>
</div>

<!-- è¨­å®šå°è©±æ¡† -->
<div id="settingsModal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.4);">
  <div class="card" style="width:min(760px,95vw); max-height:90vh; overflow:auto;">
    <h3>âš™ï¸ è¨­å®š</h3>
    <div style="display:grid; gap:10px;">
      <div class="row">
        <label class="label">æ•¸å€¼ç¯„åœï¼ˆå«è² æ•¸ï¼‰ï¼š</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <span>æœ€å°</span><input id="minVal" type="number" value="-10" style="width:100px">
          <span>æœ€å¤§</span><input id="maxVal" type="number" value="10" style="width:100px">
        </div>
      </div>
      <div class="row" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
        <label><input id="soundOn" type="checkbox" checked> å•Ÿç”¨éŸ³æ•ˆ</label>
        <label><input id="autoExam" type="checkbox" checked> ç†Ÿç·´åº¦ â‰¥80% æ™‚è‡ªå‹•è§£é–æ¸¬é©—</label>
        <label><input id="showNumlinePractice" type="checkbox" checked> ç·´ç¿’æ¨¡å¼é¡¯ç¤ºæ•¸ç·š</label>
      </div>
      <div class="row">
        <div class="label">ç†Ÿç·´åº¦è¨ˆç®—èªªæ˜ï¼š</div>
        <div class="tiny">ä»¥æœ€è¿‘ 50 é¡Œçš„æ­£ç¢ºç‡ç‚ºåŸºç¤ï¼›éŒ¯é¡Œè¤‡ç¿’å‘½ä¸­å¯åŠ é€Ÿæå‡ç†Ÿç·´åº¦ã€‚</div>
      </div>
      <hr/>
      <details>
        <summary>ï¼ˆé€²éšï¼‰Firebase é›²ç«¯æ’è¡Œæ¦œï¼ˆé¸å¡«ï¼‰</summary>
        <div class="tiny">è²¼ä¸Š Firebase Web App è¨­å®šï¼›è¼¸å…¥æˆ¿é–“ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼šee1b-114ï¼‰ï¼Œå„²å­˜å¾Œå³å•Ÿç”¨é›²ç«¯æ’è¡Œæ¦œã€‚</div>
        <textarea id="firebaseConfig" rows="6" style="width:100%; font-family:ui-monospace,monospace" placeholder='ä¾‹å¦‚ï¼š{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
        <div style="display:flex; gap:10px; align-items:center; margin-top:6px">
          <span>æˆ¿é–“ä»£ç¢¼</span><input id="roomCode" type="text" placeholder="ä¾‹å¦‚ï¼šEE1B-114" />
          <button id="btnTestCloud" class="ghost">æ¸¬è©¦é€£ç·š</button>
        </div>
        <div id="cloudStatus" class="tiny"></div>
      </details>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
        <button id="btnReset" class="flat">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <button id="btnCloseSettings">é—œé–‰</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   ç‹€æ…‹èˆ‡æŒä¹…åŒ–
======================= */
const state = {
  mode: 'practice', // practice | review | exam
  a: 0, b: 0, sign: '+', // ç›®å‰é¡Œç›®
  answer: null,
  showNumline: true,
  settings: {
    minVal: -10, maxVal: 10,
    soundOn: true,
    autoExam: true,
    showNumlinePractice: true,
    firebaseConfig: null,
    roomCode: ''
  },
  user: {
    nickname: ''
  },
  score: 0,
  streak: 0,
  best: 0,
  history: [], // {a,b,sign,correct,ans,ts}
  errorBucket: { // éŒ¯é¡Œå‹æ…‹çµ±è¨ˆ
    "(-a)+b": 0,
    "a+(-b)": 0,
    "(-a)+(-b)": 0,
    "(-a)-b": 0
  },
  reviewQueue: [], // å„ªå…ˆæŠ½éŒ¯é¡Œ
  cloud: { enabled:false, app:null, db:null }
};

const LS_KEY = 'neg_add_sub_v1';

function save(){
  const data = {
    settings: state.settings,
    user: state.user,
    score: state.score,
    streak: state.streak,
    best: state.best,
    history: state.history.slice(-200), // ä¿ç•™æœ€è¿‘ 200 é¡Œ
    errorBucket: state.errorBucket
  };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    Object.assign(state.settings, data.settings||{});
    Object.assign(state.user, data.user||{});
    state.score = data.score||0;
    state.streak = data.streak||0;
    state.best = data.best||0;
    state.history = Array.isArray(data.history)? data.history : [];
    state.errorBucket = Object.assign(state.errorBucket, data.errorBucket||{});
  }catch(e){}
}

/* =======================
   å·¥å…·ï¼šéŸ³æ•ˆï¼ˆç´” WebAudioï¼Œå…æª”æ¡ˆï¼‰
======================= */
let audioCtx;
function beep(type='good'){
  if(!state.settings.soundOn) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    if(type==='good'){ o.frequency.value = 880; }
    else if(type==='bad'){ o.frequency.value = 200; }
    else { o.frequency.value = 520; }
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.2);
    o.connect(g).connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.22);
  }catch(e){}
}

/* =======================
   é¡Œç›®ç”¢ç”Ÿã€å‹æ…‹åˆ†é¡
======================= */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

function classifyType(a, sign, b){
  const Aneg = a<0, Bneg = b<0;
  if(sign==='+'){
    if(Aneg && !Bneg) return "(-a)+b";
    if(!Aneg && Bneg) return "a+(-b)";
    if(Aneg && Bneg) return "(-a)+(-b)";
  }else{ // '-'
    if(a<0 && b>0) return "(-a)-b";
    if(a<0 && b<0) return "(-a)-(-b)"; // æ¬¡è¦ï¼šä¸åˆ—ç‚ºå››å¤§ç›£æ§ä½†ä¿ç•™åƒè€ƒ
    if(a>=0 && b>=0) return "a-b";      // æ¬¡è¦
    if(a>=0 && b<0) return "a-(-b)";    // æ¬¡è¦
  }
  return "å…¶ä»–";
}

// ä¾éœ€æ±‚å°ˆæ³¨ã€Œè² æ•¸åŠ æ¸›ã€ï¼šä¿è­‰è‡³å°‘ä¸€å€‹ç‚ºè² 
function genProblem(){
  const {minVal,maxVal} = state.settings;
  let a=0,b=0,sign = Math.random()<0.5 ? '+' : '-';
  do{
    a = randInt(minVal, maxVal);
    b = randInt(minVal, maxVal);
  }while(!(a<0 || b<0) || (a===0 && b===0)); // è‡³å°‘ä¸€å€‹è² ï¼Œä¸”é¿å… 0+0
  return {a, sign, b};
}

/* =======================
   UI ç¶å®š
======================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const elA = $('#opA'), elB = $('#opB'), elSign = $('#opSign');
const elAns = $('#answer'), elSubmit = $('#btnSubmit'), elSkip = $('#btnSkip');
const elNext = $('#btnNext'), elShowSteps = $('#btnShowSteps');
const elMsg = $('#resultMsg');
const elScore = $('#score'), elStreak = $('#streak'), elBest = $('#best'), elMastery = $('#mastery');
const elNickname = $('#nickname');
const elNumline = $('#numline'), elNumlineWrap = $('#numlineWrap');

function updateHeader(){
  elScore.textContent = state.score;
  elStreak.textContent = state.streak;
  elBest.textContent = state.best;
  elMastery.textContent = Math.round(calcMastery()*100)+'%';
  elNickname.value = state.user.nickname||'';
}

function setProblem(p){
  state.a = p.a; state.sign = p.sign; state.b = p.b;
  elA.textContent = p.a; elB.textContent = p.b; elSign.textContent = p.sign;
  elAns.value = ''; elAns.focus();
  elMsg.textContent = '';
  elNext.classList.add('hidden');
  elShowSteps.classList.add('hidden');
  // æ•¸ç·šé¡¯ç¤ºæ§åˆ¶
  const show = (state.mode==='practice' && state.settings.showNumlinePractice) || (state.mode==='review');
  state.showNumline = show;
  elNumlineWrap.classList.toggle('hidden', !show);
  if(show) drawNumberLine(p.a, p.sign, p.b, null, true);
}

function nextProblem(){
  // è‹¥æœ‰ reviewQueueï¼Œå…ˆå‡ºè¤‡ç¿’é¡Œ
  if((state.mode==='review') && state.reviewQueue.length>0){
    const q = state.reviewQueue.shift();
    setProblem(q);
    return;
  }
  if(state.mode==='review' && state.reviewQueue.length===0){
    // æ²’æ±è¥¿å°±å›ç·´ç¿’
    switchMode('practice');
    return;
  }
  // ä¸€èˆ¬å‡ºé¡Œ
  setProblem(genProblem());
}

function calcMastery(){
  const N = 50;
  const recent = state.history.slice(-N);
  if(recent.length===0) return 0;
  const corrects = recent.filter(h=>h.correct).length;
  return corrects / recent.length;
}

function pushHistory(rec){
  state.history.push(rec);
  // æ§‹å»º review queueï¼šåªæŠŠéŒ¯é¡Œæ¨å…¥ï¼Œä¸”é¿å…çˆ†é‡
  if(!rec.correct){
    state.reviewQueue.push({a:rec.a, sign:rec.sign, b:rec.b});
    if(state.reviewQueue.length>50) state.reviewQueue.shift();
  }
  save();
  renderRightPanels();
}

/* =======================
   æ•¸ç·šï¼ˆSVGï¼‰
======================= */
function drawNumberLine(a, sign, b, answer=null, animate=true){
  const {minVal, maxVal} = state.settings;
  // æ“´ä¸€äº›é‚Šç•Œï¼Œå®¹ç´æ­¥é€²
  const min = Math.min(minVal, a, a+(sign==='+'?b:-b)) - 1;
  const max = Math.max(maxVal, a, a+(sign==='+'?b:-b)) + 1;
  const w = 780, h = 130, pad=40;
  const scale = x => pad + (x - min) * ( (w - 2*pad) / (max - min) );

  const result = sign==='+' ? (a + b) : (a - b);
  const steps = (sign==='+'? b : -b); // å‘å³ç‚º +ï¼Œå‘å·¦ç‚º -
  const dir = steps>=0 ? 1 : -1;
  const nSteps = Math.abs(steps);

  let ticks = '';
  for(let x=min; x<=max; x++){
    const X = scale(x);
    const isZero = (x===0);
    ticks += `
      <line x1="${X}" y1="${h-45}" x2="${X}" y2="${h-35}" stroke="${isZero?'#c84580':'#888'}" stroke-width="${isZero?2:1}" />
      <text x="${X}" y="${h-18}" text-anchor="middle" font-size="12" fill="${isZero?'#c84580':'#555'}" font-weight="${isZero?700:400}">${x}</text>
    `;
  }

  const base = `
    <line x1="${scale(min)}" y1="${h-40}" x2="${scale(max)}" y2="${h-40}" stroke="#444" stroke-width="2" />
    ${ticks}
  `;

  // æ­¥é€²å¼§ç·š
  let arcs = '';
  let cur = a;
  for(let i=0;i<nSteps;i++){
    const x1 = scale(cur);
    const x2 = scale(cur + dir);
    const mid = (x1+x2)/2;
    const arcH = 24 + Math.min(i*3, 18);
    arcs += `
      <path d="M ${x1} ${h-42} Q ${mid} ${h-42-arcH} ${x2} ${h-42}" fill="none" stroke="${dir>0?'#7c5cff':'#ff82b1'}" stroke-width="2" marker-end="url(#arrow)"/>
    `;
    cur += dir;
  }

  // ç•¶å‰é»èˆ‡ç­”æ¡ˆé»
  const nowX = scale(a), resX = scale(result);
  const dotNow = `<circle cx="${nowX}" cy="${h-40}" r="6" fill="#4b4bb5" />`;
  const dotRes = `<circle cx="${resX}" cy="${h-40}" r="6" fill="#17b26a" />`;

  elNumline.innerHTML = `
    <defs>
      <marker id="arrow" markerWidth="12" markerHeight="12" refX="8" refY="6" orient="auto-start-reverse">
        <path d="M0,0 L12,6 L0,12 z" fill="${dir>0?'#7c5cff':'#ff82b1'}"></path>
      </marker>
    </defs>
    ${base}
    ${arcs}
    ${dotNow}
    ${answer===null? '' : dotRes}
  `;
}

/* =======================
   æª¢æŸ¥ç­”æ¡ˆã€è¨ˆåˆ†
======================= */
function submitAnswer(){
  const userAns = Number(elAns.value);
  if(Number.isNaN(userAns)) return;
  const {a,b,sign} = state;
  const correctAns = sign==='+' ? a+b : a-b;
  const ok = (userAns===correctAns);

  // è¨˜éŒ„
  const rec = {a,b,sign,ans:userAns,correct:ok, ts:Date.now()};
  pushHistory(rec);

  // éŒ¯é¡Œå‹æ…‹ç´¯ç©ï¼ˆé‡å°é—œæ³¨çš„å››å‹ï¼‰
  const typ = classifyType(a, sign, b);
  if(state.errorBucket[typ]!==undefined && !ok){
    state.errorBucket[typ] += 1;
  }

  if(ok){
    beep('good');
    state.streak += 1;
    const bonus = 10 + Math.min(state.streak*2, 30); // é€£æ“ŠåŠ æˆ
    state.score += bonus;
    elMsg.innerHTML = `âœ… æ­£ç¢ºï¼<span class="tiny">(+${bonus} åˆ†)</span>`;
    elMsg.className = 'result-msg ok';
  }else{
    beep('bad');
    state.streak = 0;
    const penalty = 3;
    state.score = Math.max(0, state.score - penalty);
    elMsg.innerHTML = `âŒ ä¸æ­£ç¢ºï¼Œæ­£è§£ç‚º <b>${correctAns}</b>`;
    elMsg.className = 'result-msg ng';
    // é¡¯ç¤ºæ­¥é©Ÿï¼ˆæ•¸ç·šï¼‰
    if(!state.showNumline){
      elShowSteps.classList.remove('hidden');
    }else{
      drawNumberLine(a, sign, b, correctAns, false);
    }
  }

  // æ›´æ–°æœ€ä½³
  if(state.score>state.best){ state.best = state.score; }

  // è‡ªå‹•è§£é–æ¸¬é©—ï¼ˆç†Ÿç·´åº¦â‰¥80%ï¼‰
  if(state.settings.autoExam){
    const m = calcMastery();
    if(m>=0.8){
      // é¡¯ç¤ºä¸€å€‹æç¤ºï¼ˆä¸å¼·åˆ¶è·³è½‰ï¼‰
      elMsg.innerHTML += `ã€€ğŸ‰ æ­å–œï¼ç†Ÿç·´åº¦å·²é” <b>${Math.round(m*100)}%</b>ï¼Œå¯ä»¥æŒ‘æˆ°ã€Œæ¸¬é©—ï¼ˆç„¡æ•¸ç·šï¼‰ã€ï¼`;
    }
  }

  // æ›æŒ‰éˆ•
  elNext.classList.remove('hidden');
  updateHeader();
  save();
  renderRightPanels();
  // æ›´æ–°æ’è¡Œæ¦œ
  updateLocalLeaderboard();
  pushCloudScoreIfAny();
}

function skipQuestion(){
  elMsg.textContent = 'å·²ç•¥éï¼Œæ›ä¸€é¡Œï¼';
  elMsg.className = 'result-msg';
  state.streak = 0;
  updateHeader();
  nextProblem();
}

function switchMode(m){
  state.mode = m;
  $$('.mode-tabs button').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.mode===m);
  });
  // æ•¸ç·šé¡¯ç¤ºä¾æ¨¡å¼
  if(state.mode==='practice'){
    state.showNumline = !!state.settings.showNumlinePractice;
  }else if(state.mode==='review'){
    state.showNumline = true; // è¤‡ç¿’ä¸€å®šæœ‰æ•¸ç·š
    // å»ºç«‹è¤‡ç¿’ä½‡åˆ—ï¼ˆå¾æ­·å²æŠ“éŒ¯é¡Œï¼‰
    const wrongs = state.history.filter(h=>!h.correct).slice(-50);
    state.reviewQueue = wrongs.map(h=>({a:h.a, sign:h.sign, b:h.b}));
  }else{ // exam
    state.showNumline = false;
  }
  nextProblem();
}

/* =======================
   å³å´é¢æ¿ï¼šæ’è¡Œæ¦œã€æœ¬æ©ŸéŒ¯é¡Œã€æ­·ç¨‹
======================= */
function renderRightPanels(){
  // éŒ¯é¡Œå‹çµ±è¨ˆ
  const et = $('#errorTypes');
  et.innerHTML = '';
  const items = Object.entries(state.errorBucket);
  if(items.every(([k,v])=>v===0)){
    et.innerHTML = `<div class="tiny">å¤ªè®šäº†ï¼ç›®å‰æ²’æœ‰æ˜é¡¯çš„å¸¸éŒ¯å‹æ…‹ã€‚</div>`;
  }else{
    for(const [k,v] of items){
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div>${k}</div>
        <div class="tiny">éŒ¯ <b>${v}</b> æ¬¡</div>
      `;
      et.appendChild(row);
    }
  }

  // æœ€è¿‘ç­”é¡Œ
  const log = $('#recentLog'); log.innerHTML='';
  const last = state.history.slice(-10).reverse();
  if(last.length===0){
    log.innerHTML = `<div class="tiny">å°šç„¡è³‡æ–™</div>`;
  }else{
    last.forEach(r=>{
      const row = document.createElement('div');
      row.className='row';
      const ans = r.sign==='+'? r.a+r.b : r.a-r.b;
      row.innerHTML = `
        <div>${r.a} ${r.sign} ${r.b} = ${ans}</div>
        <div class="${r.correct?'ok':'ng'}">${r.correct?'âœ”ï¸':'âœ–ï¸'}</div>
      `;
      log.appendChild(row);
    });
  }
}

/* =======================
   æœ¬æ©Ÿæ’è¡Œæ¦œ
======================= */
function getLocalBoard(){
  const key = 'neg_add_sub_board_v1';
  const raw = localStorage.getItem(key);
  let arr = [];
  if(raw){ try{arr = JSON.parse(raw)||[]}catch(e){} }
  return {
    list: arr,
    save(newList){ localStorage.setItem(key, JSON.stringify(newList)); }
  }
}
function updateLocalLeaderboard(){
  const board = getLocalBoard();
  const name = state.user.nickname?.trim() || 'åŒ¿åå­¸å“¡';
  // æ›´æ–°æˆ–æ’å…¥æœ€ä½³
  const existing = board.list.find(x=>x.name===name);
  if(existing){
    existing.score = Math.max(existing.score, state.best);
    existing.ts = Date.now();
  }else{
    board.list.push({name, score: state.best, ts: Date.now()});
  }
  // æ’åºå‰ 10
  board.list.sort((a,b)=> b.score - a.score || a.ts - b.ts);
  board.list = board.list.slice(0,10);
  board.save(board.list);

  // æ¸²æŸ“
  const list = $('#localRanks'); list.innerHTML='';
  if(board.list.length===0){ list.innerHTML='<div class="tiny">å°šç„¡ç´€éŒ„</div>'; return; }
  board.list.forEach((r,idx)=>{
    const row = document.createElement('div');
    row.className='row';
    const medal = idx===0?'ğŸ¥‡': idx===1?'ğŸ¥ˆ': idx===2?'ğŸ¥‰':'';
    row.innerHTML = `
      <div>${medal?`<span class="rank-medal">${medal}</span> `:''}${r.name}</div>
      <div><b>${r.score}</b></div>
    `;
    list.appendChild(row);
  });
}

/* =======================
   æ¸¬é©—è¼”åŠ©ï¼šé¡¯ç¤ºæ­¥é©Ÿ
======================= */
elShowSteps.addEventListener('click', ()=>{
  drawNumberLine(state.a, state.sign, state.b, (state.sign==='+'?state.a+state.b:state.a-state.b), true);
  elNumlineWrap.classList.remove('hidden');
  elShowSteps.classList.add('hidden');
});

/* =======================
   è¨­å®šé¢æ¿
======================= */
const modal = $('#settingsModal');
$('#btnSettings').addEventListener('click', ()=>{
  $('#minVal').value = state.settings.minVal;
  $('#maxVal').value = state.settings.maxVal;
  $('#soundOn').checked = state.settings.soundOn;
  $('#autoExam').checked = state.settings.autoExam;
  $('#showNumlinePractice').checked = state.settings.showNumlinePractice;
  $('#firebaseConfig').value = state.settings.firebaseConfig ? JSON.stringify(state.settings.firebaseConfig) : '';
  $('#roomCode').value = state.settings.roomCode || '';
  $('#cloudStatus').textContent = '';
  modal.classList.remove('hidden');
});
$('#btnCloseSettings').addEventListener('click', ()=> modal.classList.add('hidden'));
$('#btnReset').addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿå­¸ç¿’è³‡æ–™èˆ‡æœ¬æ©Ÿæ’è¡Œæ¦œå—ï¼Ÿ')){
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem('neg_add_sub_board_v1');
    location.reload();
  }
});
$('#minVal').addEventListener('change', e=>{ state.settings.minVal = Number(e.target.value); save(); });
$('#maxVal').addEventListener('change', e=>{ state.settings.maxVal = Number(e.target.value); save(); });
$('#soundOn').addEventListener('change', e=>{ state.settings.soundOn = !!e.target.checked; save(); });
$('#autoExam').addEventListener('change', e=>{ state.settings.autoExam = !!e.target.checked; save(); });
$('#showNumlinePractice').addEventListener('change', e=>{ state.settings.showNumlinePractice = !!e.target.checked; save(); });

// æš±ç¨±
elNickname.addEventListener('change', ()=>{
  state.user.nickname = elNickname.value.trim();
  save(); updateLocalLeaderboard();
});

/* =======================
   äº‹ä»¶ï¼šç­”é¡Œæµç¨‹
======================= */
elSubmit.addEventListener('click', submitAnswer);
elAns.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitAnswer(); });
elSkip.addEventListener('click', skipQuestion);
elNext.addEventListener('click', ()=>{ nextProblem(); elNext.classList.add('hidden'); });

$$('.mode-tabs button').forEach(btn=>{
  btn.addEventListener('click', ()=> switchMode(btn.dataset.mode));
});

/* =======================
   Firebaseï¼ˆé¸å¡«ï¼Œç”¨æ–¼é›²ç«¯æ’è¡Œæ¦œï¼‰
   - é è¨­ä¸è¼‰å…¥ä»»ä½•å¤–éƒ¨è…³æœ¬ï¼›åªæœ‰ä½¿ç”¨è€…åœ¨è¨­å®šè²¼å…¥ config ä¸¦æŒ‰ã€Œæ¸¬è©¦é€£ç·šã€æ‰å‹•æ…‹è¼‰å…¥ã€‚
======================= */
async function ensureFirebaseLoaded(){
  if(window.firebase && window.firebase.initializeApp) return true;
  // å‹•æ…‹è¼‰å…¥ v9 compatï¼ˆç°¡åŒ–ç¯„ä¾‹ï¼‰
  const script = document.createElement('script');
  script.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
  const script2 = document.createElement('script');
  script2.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js";
  document.head.appendChild(script);
  await new Promise(res=>script.onload=res);
  document.head.appendChild(script2);
  await new Promise(res=>script2.onload=res);
  return true;
}

$('#btnTestCloud').addEventListener('click', async ()=>{
  const cfgText = $('#firebaseConfig').value.trim();
  const room = $('#roomCode').value.trim();
  if(!cfgText || !room){ $('#cloudStatus').textContent = 'è«‹è²¼ä¸Š Firebase è¨­å®šä¸¦è¼¸å…¥æˆ¿é–“ä»£ç¢¼ã€‚'; return; }
  try{
    const cfg = JSON.parse(cfgText);
    await ensureFirebaseLoaded();
    if(state.cloud.app){ state.cloud.app.delete?.(); }
    state.cloud.app = firebase.initializeApp(cfg, 'neg-add-sub-app');
    state.cloud.db = firebase.database();
    state.cloud.enabled = true;
    state.settings.firebaseConfig = cfg;
    state.settings.roomCode = room;
    save();
    $('#cloudStatus').textContent = 'âœ… é€£ç·šæˆåŠŸï¼Œå·²å•Ÿç”¨é›²ç«¯æ’è¡Œæ¦œã€‚';
    $('#panelLeaderboardCloud').classList.remove('hidden');
    subscribeCloudLeaderboard();
  }catch(e){
    $('#cloudStatus').textContent = 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message;
    state.cloud.enabled = false;
    $('#panelLeaderboardCloud').classList.add('hidden');
  }
});

function subscribeCloudLeaderboard(){
  if(!state.cloud.enabled) return;
  const path = `/neg-add-sub/rooms/${state.settings.roomCode}/board`;
  state.cloud.db.ref(path).on('value', (snap)=>{
    const data = snap.val()||{};
    const arr = Object.values(data).sort((a,b)=> b.score - a.score || a.ts - b.ts).slice(0,10);
    renderCloudBoard(arr);
  });
}
function renderCloudBoard(arr){
  const list = $('#cloudRanks'); list.innerHTML='';
  if(arr.length===0){ list.innerHTML='<div class="tiny">å°šç„¡é›²ç«¯ç´€éŒ„</div>'; return; }
  arr.forEach((r,idx)=>{
    const medal = idx===0?'ğŸ¥‡': idx===1?'ğŸ¥ˆ': idx===2?'ğŸ¥‰':'';
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div>${medal?`<span class="rank-medal">${medal}</span> `:''}${r.name||'åŒ¿åå­¸å“¡'}</div>
      <div><b>${r.score}</b></div>
    `;
    list.appendChild(row);
  });
}
function pushCloudScoreIfAny(){
  if(!state.cloud.enabled) return;
  const name = state.user.nickname?.trim() || 'åŒ¿åå­¸å“¡';
  const path = `/neg-add-sub/rooms/${state.settings.roomCode}/board/${encodeURIComponent(name)}`;
  state.cloud.db.ref(path).set({name, score: state.best, ts: Date.now()}).catch(()=>{});
}

/* =======================
   åˆå§‹åŒ–
======================= */
function init(){
  load();
  updateHeader();
  updateLocalLeaderboard();
  renderRightPanels();

  // è‹¥æœ‰é›²ç«¯è¨­å®šï¼Œå•Ÿç”¨
  if(state.settings.firebaseConfig && state.settings.roomCode){
    (async ()=>{
      try{
        await ensureFirebaseLoaded();
        state.cloud.app = firebase.initializeApp(state.settings.firebaseConfig, 'neg-add-sub-app');
        state.cloud.db = firebase.database();
        state.cloud.enabled = true;
        $('#panelLeaderboardCloud').classList.remove('hidden');
        subscribeCloudLeaderboard();
      }catch(e){
        state.cloud.enabled = false;
        $('#panelLeaderboardCloud').classList.add('hidden');
      }
    })();
  }

  // åˆå§‹å‡ºé¡Œ
  nextProblem();
}

init();
</script>
</body>
</html>

